<html>
	<head>
		<meta charset="utf-8">
		<title>KRTCO - Raw Dump</title>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	</head>
	<body>
		<input type="file" id="files" name="files" />
		<div id="msg"></div>
	</body>
</html>

<script>
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    
    var fileName = files[0].name;
    msg("loading file '" +  fileName+ "'... ");

    var f = new FileReader();

    f.onload = function(){
    	var txt = f.result;
    	msg(files[0].size + ' bytes read OK!', true);
    	setTimeout(startDump, 500, txt);
    }
	f.readAsText(files[0]);	
    
  }

  function startDump(txt)
  {
  	msg("start dump data...", true);
  	var lines = txt.split("\n");
  	msg("raw data has " + lines.length + " lines", true);

  	var flag = 0;
  	var tempData = {};
  	var firstTimeLine = true;
  	for (var i = 0; i < lines.length; i++) {
  		var line = lines[i];
  		var txt = line.replace(/\t/g, "");

  		// 找站名
  		if (flag == 0)
  		{
  			if (txt.indexOf("站名：") == 0) {
  				tempData = {};
  				tempData.stationName = txt.replace("站名：","");
  				msg("find station: " + tempData.stationName, true);
  				flag = 1;
  			}
  		}
  		// 找日型
  		else if(flag == 1)
  		{
  			
  			if (txt.indexOf("日型：") == 0) {
  				tempData.timeType = txt.replace("日型：","");
  				msg("find timetype: " + tempData.timeType, true);
  				flag = 2;
  			}
  		}
  		// 找方向與路線
  		else if (flag == 2)
  		{
  			if (txt.indexOf("方向：") == 0) {
  				tempData.direct = txt.substr(3, 2);
  				tempData.topos = txt.substr(7);
  				msg("find direction: " + tempData.direct + " to " + tempData.topos, true);
  				flag = 3;
  			}
  		}
  		// 找"時"行
  		else if (flag == 3)
  		{
  			if (txt.indexOf("時") == 0) {
  				var hours = line.split('\t');
  				hours.shift();
  				tempData.hoursHead = hours;
  				tempData.hours = [];
  				firstTimeLine = true;
  				flag = 4;
  			}
  		}
  		// 讀取分鐘
  		else if (flag == 4)
  		{
  			msg(line);
  			var mins = line.replace("分","").split('\t');

  			var reg = /^\d+$/;
  			for (var j = 0; j < mins.length; j++) {
  				if (!reg.test(mins[j]) && mins[j] != "") 
  				{
  					flag = 5;
  					break;
  				}
  			}

  			if (flag == 5)
  			{
  				console.log(tempData);
				msg("end");
				continue;
  			}

  			for (var j = 1; j <= mins.length; j++) {
  				var min = mins[j];
  				if (min != "" || (firstTimeLine && j > 1)) {
  					if (min == "") min = 0;
  					var hHead = tempData.hoursHead[j-1];
  					if (hHead != undefined) {
	  					if (tempData.hours[hHead] == null) {
	  						tempData.hours[hHead] = [min];
	  						msg(hHead + ":" + min + " *", true);
	  					} else {
	  						tempData.hours[hHead].push(min);
	  						msg(hHead + ":" + min, true);
	  					}
	  				}
  				}
  			}

  			firstTimeLine = false;

  		}
  	};
  }

  function msg(content, newline)
  {
  	$('#msg').append(content);
  	if (newline == true) {
  		$('#msg').append('<br />');
  	}
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>